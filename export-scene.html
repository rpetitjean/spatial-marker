<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>spatial-marker - export-scene</title>
    <meta name="description" content="A demo of the Spatial-Marker component">
    
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.173.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.173.0/examples/jsm/"
  }
}
</script>

    <script src="spatial-marker.js"></script>

  </head>
  

  <body>

    <a-scene background="color: #ECECEC">

          <!-- PC & VR Rig -->
    <a-entity  id="rig" spatial-marker >
      <a-box id="camera" camera="fov:75; near: 0.1; far: 700"  position="0 1.7 0" visible="false" ></a-box>
      <a-entity id="left-hand"  meta-touch-controls="hand: left"></a-entity>
      <a-entity id="right-hand" meta-touch-controls="hand: right"></a-entity>
    </a-entity>  

      <a-plane position="0 0 -4" rotation="-90 0 0" width="6" height="6" color="#7BC8A4; opacity: 0.0; transparent: true" class="drawingArea"></a-plane>



    </a-scene>

<script type="module">
  import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';

  // ---- helpers ----
  function saveBlob(blob, filename) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 1500);
  }

  function timestampedName(prefix) {
    const t = new Date();
    const pad = n => (n < 10 ? '0' : '') + n;
    return `${prefix}_${t.getFullYear()}${pad(t.getMonth()+1)}${pad(t.getDate())}_${pad(t.getHours())}${pad(t.getMinutes())}${pad(t.getSeconds())}.glb`;
  }

  // Some scenes need a matrix world flush before export (prevents odd transforms)
  function syncWorld(rootObj3D) {
    try { rootObj3D.updateMatrixWorld(true); } catch(_) {}
  }

  // ---- export presets ----
  const REGULAR_OPTS = {
    binary: true,
    onlyVisible: true,
    embedImages: true
    // (default includeCustomExtensions:true)
  };

  // This preset avoids custom extensions & huge embedded textures;
  // helps Blender 4.x and older Windows viewers.
  const BLENDER_SAFE_OPTS = {
    binary: true,
    onlyVisible: true,
    embedImages: false,          // textures as data URIs or external refs
    includeCustomExtensions: false,
    truncateDrawRange: true,     // trims unused ranges
    trs: false
  };

  function exportGLB(rootObj3D, filenamePrefix, options) {
    const exporter = new GLTFExporter();
    syncWorld(rootObj3D);
    const name = timestampedName(filenamePrefix);
    exporter.parse(
      rootObj3D,
      (result) => saveBlob(new Blob([result], { type: 'model/gltf-binary' }), name),
      (err) => console.warn('[export] failed:', err),
      options
    );
  }

  // Friendly wrappers
  function exportSceneGLB(rootObj3D) {
    exportGLB(rootObj3D, 'spatial-marker', REGULAR_OPTS);
  }
  function exportSceneGLB_BlenderSafe(rootObj3D) {
    exportGLB(rootObj3D, 'spatial-marker_blender', BLENDER_SAFE_OPTS);
  }

  // ---- desktop shortcuts ----
  window.addEventListener('keydown', (e) => {
    const scene = document.querySelector('a-scene')?.object3D;
    if (!scene) return;
    const k = (e.key || '').toLowerCase();
    if (k === 'e') exportSceneGLB(scene);             // regular
    if (k === 'b') exportSceneGLB_BlenderSafe(scene); // blender-safe
  });

  // ---- VR dual-grip hold (no component needed) ----
  const HOLD_MS = 600;
  const left  = document.getElementById('left-hand');
  const right = document.getElementById('right-hand');
  const state = { left:false, right:false, timer:null, cooldown:false };

  function tryStartTimer() {
    if (state.timer || state.cooldown) return;
    if (state.left && state.right) {
      state.timer = setTimeout(() => {
        state.timer = null;
        if (state.left && state.right) {
          state.cooldown = true;
          setTimeout(() => state.cooldown = false, 1200);
          const scene = document.querySelector('a-scene')?.object3D;
          if (scene) {
            // Use BLENDER-SAFE by default from VR (most robust for post-workflows)
            exportSceneGLB_BlenderSafe(scene);
          }
        }
      }, HOLD_MS);
    }
  }

  function onPress(evt) {
    const side = (evt.currentTarget === left) ? 'left' : 'right';
    state[side] = true; tryStartTimer();
  }
  function onRelease(evt) {
    const side = (evt.currentTarget === left) ? 'left' : 'right';
    state[side] = false; if (state.timer) { clearTimeout(state.timer); state.timer = null; }
  }

  const pressEvts   = ['gripdown','squeezestart'];
  const releaseEvts = ['gripup','squeezeend'];
  [left, right].forEach(h => {
    if (!h) return;
    pressEvts.forEach(e => h.addEventListener(e, onPress));
    releaseEvts.forEach(e => h.addEventListener(e, onRelease));
  });
</script>



  </body>
</html>
